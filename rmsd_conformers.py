#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright 2012-2013 María José Ojeda Montes <mjose.ojeda@urv.cat>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
#This script calculate RMSD between experimental ligand with his set of conformers generated by each tool. As RMSD is lower, the conformer is closer to bioactive pose. 
#Finally, it generate an csv file that is called as the name of experimental lligand and the RMSD values for each conformer. 
#
#IT'S IMPORTANT TO HAVE IN THE SAME DIRECTORY rmsd.py FROM SCHRÖDINGER. AND ACADEMIC LICENSE. YOU CAN DOWNLOAD IN: http://www.schrodinger.com/scriptcenter/ 

import os
import csv
from glob import glob
import subprocess
import pybel
import shutil

#List of hetids
hetids = [line.strip() for line in open('hetids5370.txt',  'rb')] 

#Tools used for conformer generation. CHANGE THE NAME OF YOUR FILES TO CALCULATE THE RMSD
programs = ['BALLOON', 'CLEAN3D',  'CONFAB', 'CONFGEN', 'CYNDI', 'OMEGA', 'ROTATE', 'VCONF', 'XEDEX' ]


for hetid in hetids:   
    
    #Set of experimental poses
    bioactives = glob('Bioactive_structures/*_Rotatable_bonds/????_'+hetid+'_*.sdf')
    
    for program in programs:
        #Set of conformers generated for a specific ligand and tool. CHANGE THE PATH IF IT IS NECESSARY
        conformers = glob('Ligands_conformations/' + program + '/' + hetid + '_*.sdf')
        for conformer in conformers: 
            if not os.path.isfile(conformer):
                continue
                
            for struc_exp in bioactives:
                    print struc_exp
                    
                    #Calculate the number of rotatable bonds and number of heavy atoms and rotatable bonds. If the number of heavy atoms and rotatable bonds is the same for experiemental pose and conformers, then the RMSD will be calculate
                    mol_bioactive = pybel.readfile('sdf', struc_exp).next()
                    mol_conformation = pybel.readfile('sdf', conformer).next()
                    enrot = mol_bioactive.OBMol.NumRotors()
                    enrot_conf = mol_conformation.OBMol.NumRotors()
                    n_heavy_atoms_ref = len([atom for atom in mol_bioactive.atoms if atom.atomicnum !=1])
                    n_heavy_atoms_conf = len([atom for atom in mol_conformation.atoms if atom.atomicnum !=1])
                    
                    #Output of RMSD files
                    arxiu_rmsd = 'RMSD_conformations/' + str(enrot) + '_Rotatable/' + program + '/'
                    if not os.path.isdir(arxiu_rmsd):
                        os.makedirs(arxiu_rmsd)
                                
                    if os.path.isfile(arxiu_rmsd+ os.path.basename(struc_exp) + '_' + program +'.csv'): 
                        print 'done'
                        continue
            
                    if n_heavy_atoms_ref == n_heavy_atoms_conf: 
                        print 'Experimental structure and conformers have the same number of heavy atoms'
                        
                        if enrot == enrot_conf: 
                            print 'Experimental structure and conformers have the same number of rotatable bonds'
                        
                            # RMSD calculation by rmsd.py (script from Schrödinger.). Output is a csv file that contain RMSD values
                            try:
                                calculrmsd =  os.path.join(os.environ['SCHRODINGER'], 'run') + " rmsd.py -m " +  struc_exp  +  ' ' + conformer + " -c %s"% struc_exp + '_'+ program + ".csv" 
                                subprocess.call(calculrmsd.split()) 
                          
                                #Move the file to the output directory of rmsd 
                                csv_file = 'Bioactive_structures/' + str(enrot) +'_Rotatable_bonds/' + os.path.basename(struc_exp) + '_' + program + '.csv'
                                print csv_file
                                shutil.move(csv_file, arxiu_rmsd)
                                print 'moving csv file'
                              
                            except Exception,  error:
                                print hetid, error
                                out = open('errors_rmsd_conformers.txt','ab')
                                out.write(struc_exp + ' '+ program + '\n')
                                out.close()
                            
                    #If the number of heavy atoms is not the same, print the experiemental structure in a file. 
                    else:
                        print 'They D0NT HAVE the same number of atoms: %s vs %s' % (n_heavy_atoms_ref, n_heavy_atoms_conf)
                        out = open('rmsd_NO_same_atoms.txt','ab')
                        out.write(struc_exp + ' '+ program + '\n')
                        out.close()
            

